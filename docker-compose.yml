version: "3.8"

services:
    api-1:
        image: ghcr.io/melinia-cit/melinia-26/api:latest
        container_name: melinia-api-1
        restart: unless-stopped
        ports:
            - "3001:3000"
        env_file: .env
        environment:
            - PORT=3000

    api-2:
        image: ghcr.io/melinia-cit/melinia-26/api:latest
        container_name: melinia-api-2
        restart: unless-stopped
        ports:
            - "3002:3000"
        env_file: .env
        environment:
            - PORT=3000

    api-3:
        image: ghcr.io/melinia-cit/melinia-26/api:latest
        container_name: melinia-api-3
        restart: unless-stopped
        ports:
            - "3003:3000"
        env_file: .env
        environment:
            - PORT=3000

    api-4:
        image: ghcr.io/melinia-cit/melinia-26/api:latest
        container_name: melinia-api-4
        restart: unless-stopped
        ports:
            - "3004:3000"
        env_file: .env
        environment:
            - PORT=3000

    worker:
        image: ghcr.io/melinia-cit/melinia-26/api:latest
        container_name: melinia-worker
        restart: unless-stopped
        env_file: .env
        command: ["bun", "run", "dist/worker.js"]

    caddy:
        image: caddy:alpine
        container_name: melinia-caddy
        restart: unless-stopped
        ports:
            - "80:80"
            - "443:443"
            - "443:443/udp"
        volumes:
            - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
            - caddy_data:/data
            - caddy_config:/config
        depends_on:
            - api-1
            - api-2
            - api-3
            - api-4

volumes:
    caddy_data:
    caddy_config:

networks:
    default:
        name: melinia-network
