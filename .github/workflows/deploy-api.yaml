name: Deploy Melinia API

on:
  push:
    branches:
      - master
      - ci-pipeline
    paths:
      - "apps/api/**"
      - "packages/shared/**"
      - ".github/workflows/deploy-api.yaml"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.4

      - name: Install dependencies
        run: bun install

      - name: Build all targets
        run: bun run build:api

      - name: Prepare deployment package
        working-directory: apps/api
        run: |
          mkdir -p deploy-package
          cp dist/index.js deploy-package/
          cp dist/migrate.js deploy-package/
          cp dist/worker.js deploy-package/
          cp pm2.config.js deploy-package/

      - name: Deploy to Droplet
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_PVT_KEY }}
          source: "apps/api/deploy-package/*"
          target: "/app/melinia-api-temp"
          strip_components: 3

      - name: Deploy and restart services
        uses: appleboy/ssh-action@master
        env:
          ENV_CONTENT: ${{ secrets.ENV }}
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_PVT_KEY }}
          envs: ENV_CONTENT
          script: |
            set -e

            export PATH=$PATH:~/.bun/bin/bun

            echo "$ENV_CONTENT" > /app/melinia-api-temp/.env

            echo "Running database migrations..."
            cd /app/melinia-api-temp
            if ! bun run migrate.js; then
              echo "Migration failed! Aborting deployment."
              rm -rf /app/melinia-api-temp
              exit 1
            fi
            echo "Migrations completed successfully."

            if [ -d /app/melinia-api ]; then
              BACKUP_DIR="/app/melinia-api-backup-$(date +%Y%m%d-%H%M%S)"
              echo "Creating backup at $BACKUP_DIR"
              mv /app/melinia-api $BACKUP_DIR
            fi

            mv /app/melinia-api-temp /app/melinia-api

            cd /app/melinia-api

            pm2 delete melinia-api 2>/dev/null || true
            pm2 delete melinia-worker 2>/dev/null || true

            pm2 start pm2.config.js
            pm2 save

            echo "Deployment completed successfully!"
            pm2 status

            cd /app
            ls -dt melinia-api-backup-* 2>/dev/null | tail -n +4 | xargs rm -rf || true

            echo "Old backups cleaned up."
