services:
    prometheus:
        image: prom/prometheus:latest
        container_name: melinia-prometheus
        restart: unless-stopped
        ports:
            - "127.0.0.1:9090:9090"
        volumes:
            - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - ./config/rules:/etc/prometheus/rules:ro
            - prometheus_data:/prometheus
        command:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
            - "--storage.tsdb.retention.time=15d"
            - "--storage.tsdb.max-block-duration=2d"
            - "--storage.tsdb.min-block-duration=1d"
            - "--web.enable-remote-write-receiver"
            - "--web.read-timeout=30s"

    grafana:
        image: grafana/grafana:latest
        container_name: melinia-grafana
        restart: unless-stopped
        expose:
            - "3000"
        environment:
            - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
            - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
            - GF_USERS_ALLOW_SIGN_UP=false
            - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
            - GF_SERVER_ROOT_URL=https://${GRAFANA_DOMAIN}
        volumes:
            - grafana_data:/var/lib/grafana
            - ./config/grafana/provisioning:/etc/grafana/provisioning:ro

    alertmanager:
        image: prom/alertmanager:latest
        container_name: melinia-alertmanager
        restart: unless-stopped
        ports:
            - "127.0.0.1:9093:9093"
        volumes:
            - ./config/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
            - alertmanager_data:/alertmanager
        command:
            - "--config.file=/etc/alertmanager/alertmanager.yml"
            - "--storage.path=/alertmanager"

    node-exporter:
        image: prom/node-exporter:v1.10.2
        container_name: melinia-monitoring-node-exporter
        restart: unless-stopped
        expose:
            - "9100"
        volumes:
            - /proc:/host/proc:ro
            - /sys:/host/sys:ro
            - /:/rootfs:ro
        command:
            - "--path.procfs=/host/proc"
            - "--path.sysfs=/host/sys"
            - "--path.rootfs=/rootfs"
            - "--collector.systemd"
            - "--collector.processes"

    caddy:
        image: caddy:alpine
        container_name: melinia-monitor-caddy
        restart: unless-stopped
        ports:
            - "80:80"
            - "443:443"
            - "443:443/udp"
        volumes:
            - ./Caddyfile.monitoring:/etc/caddy/Caddyfile:ro
            - caddy_monitor_data:/data
            - caddy_monitor_config:/config

volumes:
    prometheus_data:
        driver: local
    grafana_data:
        driver: local
    alertmanager_data:
        driver: local
    caddy_monitor_data:
        driver: local
    caddy_monitor_config:
        driver: local

networks:
    default:
        name: melinia-network
